<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mediation State Viewer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Custom scrollbar for better aesthetics if needed */
        .content-display::-webkit-scrollbar {
            width: 8px;
        }
        .content-display::-webkit-scrollbar-track {
            background: rgba(0,0,0,0.1);
            border-radius: 4px;
        }
        .content-display::-webkit-scrollbar-thumb {
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        .content-display::-webkit-scrollbar-thumb:hover {
            background: rgba(0,0,0,0.5);
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="app" class="container mx-auto p-4">
        <h1 class="text-3xl font-bold text-center mb-8 text-gray-700">Mediation Simulator</h1>

        <!-- Phase Legend -->
        <div class="max-w-4xl mx-auto mb-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-sm font-semibold text-gray-600 mb-4 text-center uppercase tracking-wide">Mediation Phases</h2>
            <div class="flex flex-wrap justify-center gap-6">
                <div class="flex items-center space-x-2 px-3 py-1.5 bg-gray-50 rounded-md">
                    <div class="w-3 h-3 border-l-4 border-purple-500"></div>
                    <span class="text-sm text-gray-600">Opening Statements</span>
                </div>
                <div class="flex items-center space-x-2 px-3 py-1.5 bg-gray-50 rounded-md">
                    <div class="w-3 h-3 border-l-4 border-sky-500"></div>
                    <span class="text-sm text-gray-600">Joint Discussion</span>
                </div>
                <div class="flex items-center space-x-2 px-3 py-1.5 bg-gray-50 rounded-md">
                    <div class="w-3 h-3 border-l-4 border-indigo-500"></div>
                    <span class="text-sm text-gray-600">Caucuses</span>
                </div>
                <div class="flex items-center space-x-2 px-3 py-1.5 bg-gray-50 rounded-md">
                    <div class="w-3 h-3 border-l-4 border-teal-500"></div>
                    <span class="text-sm text-gray-600">Negotiation</span>
                </div>
                <div class="flex items-center space-x-2 px-3 py-1.5 bg-gray-50 rounded-md">
                    <div class="w-3 h-3 border-l-4 border-pink-500"></div>
                    <span class="text-sm text-gray-600">Conclusion</span>
                </div>
            </div>
        </div>

        <!-- Participant Legend -->
        <div class="max-w-4xl mx-auto mb-8 bg-white rounded-lg shadow-sm p-6">
            <h2 class="text-sm font-semibold text-gray-600 mb-4 text-center uppercase tracking-wide">Participants</h2>
            <div class="flex flex-wrap justify-center gap-6">
                <div class="flex items-center space-x-2 px-3 py-1.5 bg-gray-50 rounded-md">
                    <div class="w-3 h-3 bg-blue-50 border border-blue-200 rounded-sm"></div>
                    <span class="text-sm text-gray-600">Mediator</span>
                </div>
                <div class="flex items-center space-x-2 px-3 py-1.5 bg-gray-50 rounded-md">
                    <div class="w-3 h-3 bg-green-50 border border-green-200 rounded-sm"></div>
                    <span class="text-sm text-gray-600">Requesting Party</span>
                </div>
                <div class="flex items-center space-x-2 px-3 py-1.5 bg-gray-50 rounded-md">
                    <div class="w-3 h-3 bg-yellow-50 border border-yellow-200 rounded-sm"></div>
                    <span class="text-sm text-gray-600">Responding Party</span>
                </div>
            </div>
        </div>

        <!-- Case Summary -->
        <div v-if="caseSummary" class="max-w-4xl mx-auto mb-8 bg-white rounded-lg shadow">
            <button @click="isSummaryExpanded = !isSummaryExpanded"
                    class="w-full px-6 py-4 flex items-center justify-between text-left hover:bg-gray-50 transition-colors">
                <h2 class="text-lg font-semibold text-gray-700">Case Summary</h2>
                <svg class="w-5 h-5 text-gray-500 transform transition-transform"
                     :class="{ 'rotate-180': isSummaryExpanded }"
                     fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                </svg>
            </button>
            <div v-show="isSummaryExpanded" class="px-6 pb-6">
                <div class="prose prose-sm max-w-none" v-html="renderMarkdown(caseSummary)"></div>
            </div>
        </div>

        <div v-if="loading" class="text-center text-gray-500">
            <p>Loading mediation data...</p>
        </div>

        <div v-if="error" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">
            <strong class="font-bold">Error!</strong>
            <span class="block sm:inline">{{ error }}</span>
        </div>

        <div v-if="!loading && !error && events.length === 0" class="text-center text-gray-500">
            <p>No events found in the mediation data.</p>
        </div>

        <div class="space-y-6">
            <div v-for="event in events" :key="event.event_id"
                 :class="['rounded-lg shadow-lg overflow-hidden border-l-8', getCardBorderColor(event.mediation_phase), getCardBackgroundColor(event.speaker)]">

                <div class="p-5">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <p :class="['font-bold text-xl', getSpeakerTextColor(event.speaker)]">{{ event.speaker }}</p>
                            <p class="text-xs opacity-80">{{ event.mediation_phase }}</p>
                        </div>
                        <p class="text-xs opacity-70">{{ formatTimestamp(event.timestamp) }}</p>
                    </div>

                    <div class="mt-3 text-sm content-display max-h-96 overflow-y-auto whitespace-pre-wrap"
                         v-html="formatContent(event.content)">
                    </div>

                    <div v-if="event.summary" class="mt-4 pt-3 border-t border-opacity-20">
                        <p class="text-xs font-semibold opacity-80 mb-1">Summary:</p>
                        <p class="text-xs opacity-90 italic">{{ event.summary }}</p>
                    </div>
                     <p class="text-xs opacity-60 mt-3 text-right">Token count: {{ event.token_count }}</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    loading: true,
                    error: null,
                    rawYamlData: null,
                    events: [],
                    caseSummary: null,
                    isSummaryExpanded: false,
                    // Tailwind CSS classes for colors
                    // You can customize these colors further
                    speakerColors: {
                        MEDIATOR:         { bg: 'bg-blue-50', text: 'text-blue-700' },
                        REQUESTING_PARTY: { bg: 'bg-green-50', text: 'text-green-700' },
                        RESPONDING_PARTY: { bg: 'bg-yellow-50', text: 'text-yellow-700' },
                        CLERK_SYSTEM:     { bg: 'bg-gray-200', text: 'text-gray-700' },
                        DEFAULT:          { bg: 'bg-white', text: 'text-gray-800' }
                    },
                    phaseColors: {
                        OPENING_STATEMENTS:                'border-purple-500',
                        JOINT_DISCUSSION_INFO_GATHERING: 'border-sky-500', // Changed from yellow for better contrast with RESPONDING_PARTY
                        CAUCUSES:                          'border-indigo-500',
                        NEGOTIATION_BARGAINING:            'border-teal-500',
                        CONCLUSION_CLOSING_STATEMENTS:     'border-pink-500',
                        ENDED:                             'border-slate-500',
                        DEFAULT:                           'border-gray-300'
                    }
                }
            },
            methods: {
                async fetchMediationData() {
                    this.loading = true;
                    this.error = null;
                    try {
                        const response = await fetch('/aiq/data/axbpgcmt/mediation_state.yaml');
                        if (!response.ok) {
                            throw new Error(`HTTP error! status: ${response.status} - ${response.statusText}`);
                        }
                        const yamlText = await response.text();
                        this.rawYamlData = jsyaml.load(yamlText);
                        if (this.rawYamlData) {
                            this.events = this.rawYamlData.events || [];
                            this.caseSummary = this.rawYamlData.case_summary || null;
                        } else {
                            this.events = [];
                            this.caseSummary = null;
                            console.warn("No data found in YAML file.");
                        }
                    } catch (e) {
                        console.error("Failed to load or parse YAML:", e);
                        this.error = `Failed to load or parse mediation_state.yaml: ${e.message}. Check console for details and ensure the file exists at the correct path.`;
                    } finally {
                        this.loading = false;
                    }
                },
                getCardBorderColor(phase) {
                    return this.phaseColors[phase] || this.phaseColors.DEFAULT;
                },
                getCardBackgroundColor(speaker) {
                    return (this.speakerColors[speaker] || this.speakerColors.DEFAULT).bg;
                },
                getSpeakerTextColor(speaker) {
                     return (this.speakerColors[speaker] || this.speakerColors.DEFAULT).text;
                },
                formatTimestamp(timestamp) {
                    if (!timestamp) return '';
                    try {
                        return new Date(timestamp).toLocaleString();
                    } catch (e) {
                        return timestamp; // fallback to raw if parsing fails
                    }
                },
                formatContent(content) {
                    if (!content) return '';
                    // Basic **bold** to <strong>bold</strong> conversion
                    // Escape HTML to prevent XSS if content can be arbitrary,
                    // then apply safe formatting. For this case, assuming ** is the only format.
                    let safeContent = content.replace(/&/g, "&").replace(/</g, "<").replace(/>/g, ">");
                    return safeContent.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                },
                renderMarkdown(text) {
                    if (!text) return '';
                    // Configure marked options
                    marked.setOptions({
                        breaks: true, // Convert line breaks to <br>
                        gfm: true,    // GitHub Flavored Markdown
                        headerIds: false, // Disable header IDs for security
                        mangle: false,    // Disable header ID mangling
                        sanitize: false   // We'll handle sanitization ourselves
                    });

                    // Basic sanitization to prevent XSS
                    const sanitized = text
                        .replace(/&/g, '&amp;')
                        .replace(/</g, '&lt;')
                        .replace(/>/g, '&gt;');

                    return marked.parse(sanitized);
                }
            },
            mounted() {
                this.fetchMediationData();
            }
        }).mount('#app');
    </script>
</body>
</html>